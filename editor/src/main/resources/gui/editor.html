<!DOCTYPE html>
<html>
<head>
    <style id="style"></style>
    <script>
        /* DEBUG FUNCTIONS! */
        function stringify_path(node)
        {
            var ret = "";

            while(node != null)
            {
                switch(node.nodeType)
                {
                    case 1:
                        var attrs = node.attributes;
                        if(attrs.length != 0)
                        {
                            ret = "]/" + ret;
                            for(i = 0; i < attrs.length; ++i)
                            {
                                if(i != 0)
                                    ret = "," + ret;

                                var attr = attrs.item(i);
                                ret = attr.name + "='" + attr.value + "'" + ret;
                            }
                            ret = "[" + ret;
                        }
                        ret = node.nodeName + ret;
                        break;
                    case 3:
                        ret = node.nodeName + "[text='" + node.textContent + "']" + "/" + ret;
                        break;
                    default:
                        ret = node.nodeName + "/" + ret;
                        break;
                }

                node = node.parentNode;
            }

            return ret;
        }

        function stringify_range(range)
        {
            var ret = "";
            ret += "start = " + stringify_path(range.startContainer) + "[" + range.startOffset + "]";
            ret += "end   = " + stringify_path(range.endContainer) + "[" + range.endOffset + "]";
            return ret;
        }

        function make_selection_valid(e)
        {
            var selection = window.getSelection();
            var editor = document.getElementById("editor");

            if(selection.rangeCount < 1 ||
               !editor.contains(selection.anchorNode) ||
               !editor.contains(selection.focusNode))
            {
                selection.removeAllRanges();

                var range = document.createRange();
                range.setStart(editor, 0);
                range.setEnd(editor, 0);
                selection.addRange(range);
            }
        }
        document.addEventListener("click", make_selection_valid);
        document.addEventListener("keypress", make_selection_valid);

        function get_selected_range()
        {
            var selection = window.getSelection();
            if(selection.rangeCount < 1)
            {
                var range = document.createRange();
                range.setStart(editor, 0);
                range.setEnd(editor, 0);
                return range;
            }
            else
            {
                return selection.getRangeAt(0);
            }
        }

        function get_range_as_text_offset(node, range)
        {
            var node = range.startContainer;

            var offset = range.startOffset;
            var prev_node = null;
            while(node && node.nodeType == 3)
            {
                /* Not for the first node. We use startOffset for text nodes. */
                if(prev_node)
                    offset += node.textContent.length;
                prev_node = node;
                node = node.previousSibling;
            }

            if(node)
            {
                // java.debug("0");
                offset += parseInt(node.getAttribute("data-end"));
            }
            else
            {
                // java.debug("1");
                offset += parseInt(prev_node.parentNode.getAttribute("data-start"));
            }

            // java.debug("offset = " + offset);
            return offset;
        }

        function new_range_by_text_offset(node, offset)
        {
            while(node != null)
            {
                var new_offset = offset - node.textContent.length;

                if(new_offset <= 0)
                {
                    if(node.firstChild == null)
                    {
                        var range = new Range();
                        range.setStart(node, offset);
                        range.setEnd(node, offset);
                        return range;
                    }
                    else
                    {
                        node = node.firstChild;
                    }
                }
                else
                {
                    offset = new_offset;
                    node = node.nextSibling;
                }
            }

            return null;
        }

        function maybe_scroll_to_range(range)
        {
            var hidden = document.createElement("span");
            hidden.textContent = ".";
            range.insertNode(hidden);
            hidden.scrollIntoViewIfNeeded(false);
            hidden.parentNode.removeChild(hidden);
        }

        function start_incremental_parsing(range)
        {
            var start_node = -1;
            var end_node = -1;

            /* Find the start and end of the area we need to reparse. */
            for(var i = 0; i < 2; ++i)
            {
                var id = -1;

                if(i == 0)
                    var node = range.startContainer;
                else
                    var node = range.endContainer;

                var is_first = true;
                var is_last = true;

                if(node.nodeType == 3)
                {
                    if(range.startOffset-1 != 0)
                        is_first = false;
                    if(range.endOffset-1 == node.textContent.length-1)
                        is_last = false;

                    node = node.parentElement;
                };

                var prev_node = node;
                /* Find the parent hm_node_ _OR_ go all the way back up to the
                 * editor node. */
                while(
                    !node.getAttribute('id') ||
                    (
                        !node.getAttribute('id').toLowerCase() == "editor" &&
                        !node.getAttribute('id').startsWith('hm_node_')
                    )
                )
                {
                    if(node.previousSibling)
                        is_first = false;
                    if(node.nextSibling)
                        is_last = false;

                    prev_node = node;
                    node = node.parentElement;
                }


                if(node.getAttribute('id').toLowerCase() == "editor")
                {
                    /* Start with our parent one below the editor node. */
                    node = prev_node;

                    while(
                        node.nodeType != 1 ||
                        !node.getAttribute('id') ||
                        !node.getAttribute('id').startsWith('hm_node_')
                    )
                    {
                        if(i == 0)
                            node = node.previousSibling;
                        else
                            node = node.nextSibling;

                        /* If we didn't find any we need to start to reparse
                         * from the edges. */
                        if(!node)
                            break;
                    }

                    /* If we know we need to reparse from the edges we already
                       found our bounds. */
                    if(!node)
                    {
                        if(i == 0)
                            start_node = -1;
                        else
                            end_node = -1;

                        break;
                    }
                }

                if(is_first && i == 0)
                    node = node.previousSibling;
                if(is_last && i != 0)
                    node = node.nextSibling;

                if(node && node.nodeType == 1)
                {
                    var id_str = node.getAttribute('id');
                    if(id_str)
                    {
                        var match = id_str.match(/^hm_node_(\d+)$/);
                        if(match)
                            id = parseInt(match[1]);
                    }
                }

                if(i == 0)
                    start_node = id;
                else
                    end_node = id;
            }

            var range = get_selected_range();
            if(start_node >= 0)
                node = document.getElementById("hm_node_" + start_node);
            else
                node = editor.firstChild;
            var offset = get_range_as_text_offset(node, range);

            var id = java.start_parsing(start_node, end_node);

            node = document.getElementById("hm_node_" + id);

            var range = new_range_by_text_offset(node, offset);

            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        document.addEventListener("keydown",
            function(e)
            {
                make_selection_valid(e);

                if(e.keyCode == 8)
                {
                    e.stopPropagation();
                    e.preventDefault();

                    var selection = window.getSelection();
                    if(selection.isCollapsed)
                        selection.modify("extend", "backward", "character");

                    selection.deleteFromDocument();

                    make_selection_valid(e);
                    maybe_scroll_to_range(get_selected_range());
                    start_incremental_parsing(get_selected_range());
                }
                else if(e.keyCode == 46)
                {
                    e.stopPropagation();
                    e.preventDefault();

                    var selection = window.getSelection();
                    if(selection.isCollapsed)
                        selection.modify("extend", "forward", "character");

                    selection.deleteFromDocument();

                    make_selection_valid(e);
                    maybe_scroll_to_range(get_selected_range());
                    start_incremental_parsing(get_selected_range());
                }
            }
        );

        document.addEventListener("keypress",
            function(e)
            {
                make_selection_valid(e);

                e.stopPropagation();
                e.preventDefault();

                var range = get_selected_range().cloneRange();
                range.deleteContents();

                var new_text = String.fromCharCode(e.charCode);
                if(e.charCode == 13)
                {
                    new_text = "\n";
                }

                var text = document.createTextNode(new_text);
                range.insertNode(text);
                range.selectNode(text);
                range.collapse(false);

                var selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                make_selection_valid(e);
                maybe_scroll_to_range(range);
                start_incremental_parsing(range);
            }
        );

        document.addEventListener("paste",
            function(e)
            {
                make_selection_valid(e);

                e.stopPropagation();
                e.preventDefault();

                var hm_node_id_left = 0;
                var hm_node_id_right = 0;

                var clipboard_data = e.clipboardData;
                var text = clipboard_data.getData('text/plain');

                var range = get_selected_range().cloneRange();
                range.deleteContents();
                var text_node = document.createTextNode(text);
                range.insertNode(text_node);
                range.selectNode(text_node);
                range.collapse(false);

                var selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                maybe_scroll_to_range(range);
                start_incremental_parsing(range);
            }
        );
    </script>
</head>
<body>
    <div id="numbers"></div>
    <div id="editor" contenteditable="true"></div>
</body>
</html>
