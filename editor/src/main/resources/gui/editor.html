<!DOCTYPE html>
<html>
<head>
    <style id="style"></style>
    <script>
        /* DEBUG FUNCTIONS! */
        function stringify_path(node)
        {
            var ret = "";

            while(node != null)
            {
                switch(node.nodeType)
                {
                    case 1:
                        var attrs = node.attributes;
                        if(attrs.length != 0)
                        {
                            ret = "]/" + ret;
                            for(i = 0; i < attrs.length; ++i)
                            {
                                if(i != 0)
                                    ret = "," + ret;

                                var attr = attrs.item(i);
                                ret = attr.name + "='" + attr.value + "'" + ret;
                            }
                            ret = "[" + ret;
                        }
                        ret = node.nodeName + ret;
                        break;
                    case 3:
                        var content = node.textContent;
                        if(content.length > 32)
                            content = content.substring(0, 29) + "...";
                        ret = node.nodeName + "[text='" + content + "']" + "/" + ret;
                        break;
                    default:
                        ret = node.nodeName + "/" + ret;
                        break;
                }

                node = node.parentNode;
            }

            return ret;
        }

        function stringify_range(range)
        {
            var ret = "";
            ret += "start = " + stringify_path(range.startContainer) + "[" + range.startOffset + "]";
            ret += "end   = " + stringify_path(range.endContainer) + "[" + range.endOffset + "]";
            return ret;
        }

        function make_selection_valid(e)
        {
            var selection = window.getSelection();
            var editor = document.getElementById("editor");

            if(selection.rangeCount < 1 ||
               !editor.contains(selection.anchorNode) ||
               !editor.contains(selection.focusNode))
            {
                selection.removeAllRanges();

                var range = document.createRange();
                range.setStart(editor, 0);
                range.setEnd(editor, 0);
                selection.addRange(range);
            }
        }
        document.addEventListener("click", make_selection_valid);
        document.addEventListener("keypress", make_selection_valid);

        function get_selected_range()
        {
            var selection = window.getSelection();
            if(selection.rangeCount < 1)
            {
                var range = document.createRange();
                range.setStart(editor, 0);
                range.setEnd(editor, 0);
                return range;
            }
            else
            {
                return selection.getRangeAt(0).cloneRange();
            }
        }

        function maybe_scroll_to_range(range)
        {
            var hidden = document.createElement("span");
            hidden.textContent = ".";
            range.insertNode(hidden);
            hidden.scrollIntoViewIfNeeded(false);
            hidden.parentNode.removeChild(hidden);
        }

        var parse_timeout = null;
        var parse_start = Infinity;
        var parse_end = -Infinity;
        function start_incremental_parsing_throttled(range)
        {
            if(parse_timeout)
                clearTimeout(parse_timeout);

            ids = get_range_start_end(range);
            if(ids[0] == -1)
                parse_start = -1;
            else
                parse_start = Math.min(parse_start, ids[0]);

            if(ids[1] == -1)
                parse_end = -1;
            else
                parse_end = Math.max(parse_end, ids[1]);

            parse_timeout = setTimeout(
                function()
                {
                    parse_timeout = null;
                    start_incremental_parsing(parse_start, parse_end);
                    parse_start = Infinity;
                    parse_end = -Infinity;
                },
                100
            );
        }

        function get_range_start_end(range)
        {
            var start_node = -1;
            var end_node = -1;

            /* Find the start and end of the area we need to reparse. */
            for(var i = 0; i < 2; ++i)
            {
                var id = -1;

                if(i == 0)
                    var node = range.startContainer;
                else
                    var node = range.endContainer;

                var is_first = true;
                var is_last = true;

                var prev_node = null;
                if(node.nodeType == 3)
                {
                    if(range.startOffset > 1)
                        is_first = false;
                    if(range.endOffset < node.textContent.length-1)
                        is_last = false;
                }
                else
                {
                    /* For determining is_first and is_last in the next
                       part we need to start with the pointed-to child note
                       instead of the container. */
                    prev_node = node;

                    if(i == 0)
                        node = node.childNodes.item(range.startOffset);
                    else
                        node = node.childNodes.item(range.endOffset);
                }

                if(!node)
                    node = prev_node;

                prev_node = null;
                var is_prev_first = is_first;
                var is_prev_last  = is_last;
                /* Find the node one before the editor node. */
                while(
                    node.nodeType != 1 ||
                    !node.getAttribute('id') ||
                    node.getAttribute('id').toLowerCase() != "editor"
                )
                {
                    is_prev_first = is_first;
                    is_prev_last  = is_last;

                    if(node.previousSibling)
                        is_first = false;
                    if(node.nextSibling)
                        is_last = false;

                    prev_node = node;
                    node = node.parentNode;
                }

                node = prev_node;
                is_first = is_prev_first;
                is_last = is_prev_last;

                /* We found only the editor node. */
                if(!node)
                {
                    if(i == 0)
                        start_node = -1;
                    else
                        end_node = -1;
                    continue;
                }

                if(is_first && i == 0)
                    node = node.previousSibling;
                if(is_last && i != 0)
                    node = node.nextSibling;

                if(node && node.nodeType == 1)
                {
                    var id_str = node.getAttribute('id');
                    if(id_str)
                    {
                        var match = id_str.match(/^hm_node_(\d+)$/);
                        if(match)
                            id = parseInt(match[1]);
                    }
                }

                if(i == 0)
                    start_node = id;
                else
                    end_node = id;
            }

            return [start_node, end_node];
        }

        function start_incremental_parsing(start_node, end_node)
        {
            if(start_node >= 0)
                node = document.getElementById("hm_node_" + start_node);
            else
                node = editor.firstChild;

            /* START: CREATE selection marker */
            var cursor_start = document.createElement("span");
            cursor_start.setAttribute('id', 'cursor_start');

            var cursor_end = document.createElement("span");
            cursor_end.setAttribute('id', 'cursor_end');

            var old_range = get_selected_range();

            old_range.insertNode(cursor_start);
            old_range.collapse(false);
            old_range.insertNode(cursor_end);
            /* END: CREATE selection marker */

            java.start_parsing(start_node, end_node);

            /* START: USE & DELETE selection marker */
            cursor_start = document.getElementById("cursor_start");
            cursor_end = document.getElementById("cursor_end");

            var new_range = document.createRange();
            new_range.setStart(cursor_start, 0);
            new_range.setEnd(cursor_end, 0);

            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(new_range);

            cursor_start.parentNode.removeChild(cursor_start);
            cursor_end.parentNode.removeChild(cursor_end);
            /* END: USE & DELETE selection marker */

            update_line_numbers();
        }

        function update_line_numbers()
        {
            var editor = document.getElementById("editor");
            var line_numbers = document.getElementById("numbers");

            while(line_numbers.hasChildNodes())
                line_numbers.removeChild(line_numbers.firstChild);

            var editor_rect = editor.getBoundingClientRect();
            line_numbers.style.height = "" + editor.offsetHeight + "px";

            var elements = document.getElementsByClassName("new_line");
            var height = window.innerHeight || document.documentElement.clientHeight;

            /* Don't recalculate them if they are more than 2 windows out of the screen. */

            /* Search for the element with the smallest rect.top that is bigger than -height. */
            var min = 0;
            var max = elements.length;
            var index;
            do
            {
                index = ((max + min)/2) >> 0; /* Integer maths! */

                if(min+1 >= max)
                    break;

                var element = elements.item(index);
                var rect = element.getBoundingClientRect();

                if(rect.top < -height)
                {
                    min = index;
                }
                else if(rect.top > -height)
                {
                    max = index;
                }
                else
                {
                    break;
                }
            }
            while(min != max);

            /* Now iterate through the elements until the first one has a bottom that is further down than 2*height */;
            for(var i = index; i < elements.length; i++)
            {
                var element = elements.item(i);

                var rect = element.getBoundingClientRect();
                if(rect.bottom - height > height)
                    break;

                var top = rect.top - editor_rect.top;

                number = document.createElement("div");
                number.setAttribute("class", "line_number");
                number.textContent = "" + i;
                number.style.position = "absolute";
                number.style.top = "" + top + "px";
                number.style.height = "0px";
                number.style.width = "2.5em";
                number.style.textAlign = "right";
                number.style.overflow = "visible";
                number.style.color = "gray";

                line_numbers.appendChild(number);
            }
        }

        document.addEventListener("keydown",
            function(e)
            {
                if(e.keyCode == 8)
                {
                    e.stopPropagation();
                    e.preventDefault();

                    var selection = window.getSelection();
                    if(selection.isCollapsed)
                        selection.modify("extend", "backward", "character");

                    selection.deleteFromDocument();

                    maybe_scroll_to_range(get_selected_range());
                    start_incremental_parsing_throttled(get_selected_range());
                }
                else if(e.keyCode == 46)
                {
                    e.stopPropagation();
                    e.preventDefault();

                    var selection = window.getSelection();
                    if(selection.isCollapsed)
                        selection.modify("extend", "forward", "character");

                    selection.deleteFromDocument();

                    maybe_scroll_to_range(get_selected_range());
                    start_incremental_parsing_throttled(get_selected_range());
                }
                else if(e.keyCode == 13)
                {
                    e.stopPropagation();
                    e.preventDefault();

                    var range = get_selected_range();
                    range.deleteContents();

                    var text = document.createTextNode("\n");
                    range.insertNode(text);
                    range.selectNode(text);
                    range.collapse(false);

                    maybe_scroll_to_range(range);
                    start_incremental_parsing_throttled(range);

                    var selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        );

        document.addEventListener("keypress",
            function(e)
            {
                e.stopPropagation();
                e.preventDefault();

                var range = get_selected_range();
                range.deleteContents();

                var new_text = String.fromCharCode(e.charCode);
                var text = document.createTextNode(new_text);
                range.insertNode(text);
                range.selectNode(text);
                range.collapse(false);

                maybe_scroll_to_range(range);
                start_incremental_parsing_throttled(range);

                var selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
        );

        document.addEventListener("paste",
            function(e)
            {
                e.stopPropagation();
                e.preventDefault();

                var hm_node_id_left = 0;
                var hm_node_id_right = 0;

                var clipboard_data = e.clipboardData;
                var text = clipboard_data.getData('text/plain');

                var range = get_selected_range();
                range.deleteContents();
                var text_node = document.createTextNode(text);
                range.insertNode(text_node);
                range.selectNode(text_node);
                range.collapse(false);

                var selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                maybe_scroll_to_range(range);
                start_incremental_parsing_throttled(range);
            }
        );

        window.addEventListener("resize",
            function(e)
            {
                line_number_update_throttled();
            }
        );

        window.addEventListener("scroll",
            function(e)
            {
                line_number_update_throttled();
            }
        );

        var line_number_timeout = null;
        function line_number_update_throttled()
        {
            if(line_number_timeout)
                clearTimeout(line_number_timeout);

            line_number_timeout = setTimeout(
                function()
                {
                    line_number_timeout = null;
                    update_line_numbers();
                },
                200
            );
        }
    </script>
</head>
<body>
    <div id="numbers"></div>
    <div id="editor" contenteditable="true" data-start="0"></div>
</body>
</html>
